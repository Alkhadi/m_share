<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>M Share ‚Ä¢ Storage Room</title>
  <meta name="description" content="Manage your PDFs: generate placeholder, add local files, download.">
  <link rel="stylesheet" href="style.css" />
  <script>
    // --- Admin gate (no password): enable with ?admin=1 for the session ---
    (function adminSessionGate(){
      const P = new URLSearchParams(location.search);
      if (P.get('admin') === '1') sessionStorage.setItem('mshare_admin_ok', '1');
      if (P.get('admin') === '0') sessionStorage.removeItem('mshare_admin_ok');
      if (sessionStorage.getItem('mshare_admin_ok') !== '1') {
        // Hidden from non-admin: redirect away silently.
        location.replace('index.html');
      }
    })();
  </script>
  <style>
    .note{color:var(--muted)}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container navbar">
      <a id="brandLink" class="brand"><span class="logo">M</span> M Share</a>
      <nav class="main-nav" id="mainNav">
        <a data-href="index.html">Wellbeing</a>
        <a data-href="coffee.html">Buy Me Coffee</a>
        <button id="shareOpen" class="btn" type="button"><span class="icon">üîó</span> Share</button>
      </nav>
      <button id="navToggle" class="nav-toggle" aria-label="Menu">‚ò∞</button>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <h1>Storage Room (Admin)</h1>
      <p class="muted">Place your official PDF at <code>/assets/m_share_profile.pdf</code>. Or use the device locker below‚Äîno server required.</p>
      <div class="actions">
        <button id="makePlaceholder" class="btn btn-primary">Generate Styled Placeholder ‚Üí Device Locker</button>
        <label class="btn"><input id="addPdf" type="file" accept="application/pdf" style="display:none"/>‚ûï Add PDF from device</label>
        <a class="btn" href="pdf.html">Open PDF page</a>
      </div>
      <p class="note">Tip: Turn admin off with <code>?admin=0</code> or by closing the browser.</p>
    </div>

    <div class="card">
      <h2>Device Locker</h2>
      <div class="actions">
        <div class="badge">Quota used: <span id="quotaUsed">0</span> / <span id="quotaMax">5</span> files</div>
        <button id="exportLocker" class="btn">‚¨á Export Locker (.json)</button>
        <label class="btn">üì§ Import Locker<input id="importLocker" type="file" accept="application/json" style="display:none"></label>
      </div>
      <div id="lockerList"></div>
      <p class="muted" style="margin-top:10px">Files are stored as Blob URLs in local storage on this device only.</p>
    </div>

    <div class="footer">¬© <span id="year"></span> Pure Care Plus.co.uk Ltd</div>
  </main>

  <!-- Share sheet -->
  <div id="shareSheet" class="sheet hidden">
    <div id="shareBackdrop" style="position:absolute; inset:0;"></div>
    <div class="sheet-card" role="dialog" aria-modal="true" aria-labelledby="shareTitle">
      <div class="sheet-head">
        <h2 id="shareTitle" class="sheet-title">Share this site</h2>
        <button id="shareClose" class="sheet-close" aria-label="Close">√ó</button>
      </div>
      <textarea id="shareText" class="share-text" readonly></textarea>
      <div class="share-actions">
        <button class="btn" id="copyShare">üìã Copy</button>
        <button class="btn" id="shareNative">üîó Share‚Ä¶</button>
        <button class="btn" id="savePng">üñºÔ∏è Save PNG card</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // Locker (quota + import/export)
    (function locker(){
      const KEY='mshare_pdf_locker_v1';
      const MAX_FILES = 5; // simple per-device quota (by count)
      const load = ()=>{ try{ return JSON.parse(localStorage.getItem(KEY)||'[]')||[]; }catch{ return []; } };
      const save = (arr)=>{ try{ localStorage.setItem(KEY, JSON.stringify(arr)); }catch{} };

      function updateQuotaView(){
        const list = load();
        document.getElementById('quotaUsed').textContent = String(list.length);
        document.getElementById('quotaMax').textContent = String(MAX_FILES);
      }

      function render(){
        const list = load();
        const wrap = document.getElementById('lockerList'); wrap.innerHTML='';
        if (!list.length) { wrap.innerHTML='<div class="muted">No PDFs stored on this device yet.</div>'; updateQuotaView(); return; }
        list.forEach((f,i)=>{
          const row=document.createElement('div'); row.className='kv';
          row.innerHTML = `<div><b>${(f.name||'PDF')}</b> <span class="muted">(${Math.round((f.size||0)/1024)} KB)</span></div>
            <div class="actions" style="margin-top:8px">
              <a class="btn" href="${f.data}" download="${f.name||'document.pdf'}">‚¨á Download</a>
              <a class="btn" href="${f.data}" target="_blank" rel="noopener">üîé Open</a>
              <button class="btn btn-danger" data-i="${i}">üóë Remove</button>
            </div>`;
          wrap.appendChild(row);
        });
        wrap.querySelectorAll('button[data-i]').forEach(b=> b.addEventListener('click',()=>{
          const i=+b.dataset.i; const list=load(); list.splice(i,1); save(list); render();
        }));
        updateQuotaView();
      }
      render();

      document.getElementById('addPdf')?.addEventListener('change', async (e)=>{
        const file = e.target.files?.[0]; if(!file) return;
        const list = load();
        if (list.length >= MAX_FILES) { window.__MSHARE__?.toast?.('Quota reached. Remove a file first.'); e.target.value=''; return; }
        if (!file.type || !file.type.includes('pdf')) { window.__MSHARE__?.toast?.('Only PDF files are allowed.'); e.target.value=''; return; }
        const buf = await file.arrayBuffer();
        const url = URL.createObjectURL(new Blob([buf],{type:'application/pdf'}));
        list.push({ name:file.name, size:file.size, data:url, ts:Date.now() });
        save(list); render(); e.target.value='';
      });

      document.getElementById('makePlaceholder')?.addEventListener('click', async ()=>{
        try{
          const preview = await window.__MSHARE__.buildStyledCardCanvas({});
          const blob = await window.__MSHARE__.generateStyledPdf({fromCanvas: preview.canvas, links: preview.links});
          const url = URL.createObjectURL(blob);
          const list = load();
          if (list.length >= MAX_FILES) { window.__MSHARE__?.toast?.('Quota reached. Remove a file first.'); return; }
          list.push({ name:'m_share_profile.pdf', size: blob.size, data:url, ts:Date.now() });
          save(list); render();
        }catch(e){ window.__MSHARE__?.toast?.('Could not generate placeholder PDF.'); }
      });

      // Export / Import
      document.getElementById('exportLocker')?.addEventListener('click', ()=>{
        const list = load();
        const blob = new Blob([JSON.stringify(list)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='mshare_locker_backup.json';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });
      document.getElementById('importLocker')?.addEventListener('change', async (e)=>{
        const file = e.target.files?.[0]; if(!file) return;
        try{
          const text = await file.text();
          const data = JSON.parse(text);
          if (!Array.isArray(data)) throw new Error('Invalid backup');
          const merged = data.slice(0, MAX_FILES);
          save(merged); render();
        }catch{ window.__MSHARE__?.toast?.('Import failed. Invalid file.'); }
        e.target.value='';
      });
    })();
  </script>
</body>
</html>
